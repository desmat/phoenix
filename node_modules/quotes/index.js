var request = require('request');

module.exports = {

	getQuote: function(ticker, cb) {

		var url = 'https://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20yahoo.finance.quotes%20where%20symbol%20in%20(%22' + ticker + '%22)%0A%09%09&format=json&diagnostics=false&env=http%3A%2F%2Fdatatables.org%2Falltables.env';
		request(url, function(err, resp, body) {
			if (err) return cb(err);

			var data = JSON.parse(body);
			var name =  data.query.results.quote.Name;

			if (!data.query.results.quote.Name) return cb("Ticker not found: " + ticker);

			cb(null, data.query.results.quote);
		});
	},

	getQuotes: function(tickers, cb) {
		var tickersToQuery = '';
		for (var i = 0; i < tickers.length; i++) {
			tickersToQuery += '%22' + tickers[i] + '%22' + '%2C';
		}
		tickersToQuery = tickersToQuery.substring(0, tickersToQuery.length - 3)

		var url = 'https://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20yahoo.finance.quotes%20where%20symbol%20in%20(' + tickersToQuery + ')%0A%09%09&format=json&diagnostics=false&env=http%3A%2F%2Fdatatables.org%2Falltables.env';
		request(url, function(err, resp, body) {
			if (err) return cb(err);

			var data = JSON.parse(body);
			if (data.query.count === 1) {
				cb(null, [data.query.results.quote]);
			}
			else {
				cb(null, data.query.results.quote);
			}
		});
	}
}
